name: Flujo de ProducciÃ³n y OpenProject

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deploy-logic:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validar PreproducciÃ³n
        if: github.event_name == 'pull_request'
        run: echo "âœ… PreproducciÃ³n OK"

      - name: Actualizar OpenProject
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.repository == 'CharlyB03/CharlyPruebaProd'
        env:
          OP_API_KEY: ${{ secrets.OP_API_KEY }}
          OP_URL: ${{ secrets.OP_INSTANCE_URL }}
          OP_NEW_STATUS_ID: ${{ secrets.OP_STATUS_ID }}
        run: |
          # --- OBTENER DATOS ---
          COMMIT_MSG=$(git log -1 --pretty=%s)
          SHA_CURRENT=$(git rev-parse --short HEAD)
          SHA_PARENT=$(git log --merges --grep="Merge pull request" -n 2 --pretty=%h | tail -n 1)
          REPO_NAME=${GITHUB_REPOSITORY#*/}

          # --- EXTRAER ID TICKET ---
          BRANCH_FULL=$(echo "$COMMIT_MSG" | grep -oE 'from .+' | awk '{print $NF}')
          if [ -z "$BRANCH_FULL" ]; then BRANCH_FULL="$COMMIT_MSG"; fi
          TICKET_ID=$(echo "$BRANCH_FULL" | grep -oE '[0-9]+$' | head -n 1)
          
          if [ -z "$TICKET_ID" ]; then
            echo "âš ï¸ No se detectÃ³ ID. Fin."
            exit 0
          fi

          # --- OBTENER EMAIL DEL RESPONSABLE EN OPENPROJECT ---
          # 1. Obtenemos el link al responsable desde el Work Package
          WP_DATA=$(curl -s -u "apikey:$OP_API_KEY" "$OP_URL/api/v3/work_packages/$TICKET_ID")
          RESPONSIBLE_HREF=$(echo "$WP_DATA" | jq -r '._links.responsible.href // empty')
          
          if [ ! -z "$RESPONSIBLE_HREF" ]; then
            # 2. Consultamos el email en el perfil del responsable
            USER_EMAIL=$(curl -s -u "apikey:$OP_API_KEY" "$OP_URL$RESPONSIBLE_HREF" | jq -r '.email')
            echo "TARGET_EMAIL=$USER_EMAIL" >> $GITHUB_ENV
            echo "ðŸŽ¯ Responsable detectado: $USER_EMAIL"
          else
            # Fallback a tu correo si no hay responsable asignado
            echo "TARGET_EMAIL=charly.bazan.2003@gmail.com" >> $GITHUB_ENV
            echo "âš ï¸ No hay responsable asignado. Usando fallback."
          fi

          # Exportar datos para el paso de correo
          echo "TICKET_ID=$TICKET_ID" >> $GITHUB_ENV
          echo "SHA_CURRENT=$SHA_CURRENT" >> $GITHUB_ENV
          echo "COMMIT_MSG=$COMMIT_MSG" >> $GITHUB_ENV
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV

          # --- DATOS DE VERSIONAMIENTO Y ARCHIVOS (NOTAS) ---
          read -r -d '' VERSION_NOTE <<EOM || true
          *Datos de versionamiento en producciÃ³n*
          *Versionado en:* $REPO_NAME (GitHub)
          *Commit:* $COMMIT_MSG
          *sha1:* $SHA_CURRENT
          *sha1 Parent:* $SHA_PARENT
          *Extraer Archivos:*
          \`\`\`bash
          git --no-pager diff --name-only $SHA_PARENT $SHA_CURRENT
          \`\`\`
          EOM

          FILES_LIST=$(git diff --name-only $SHA_PARENT $SHA_CURRENT | awk -F/ '{
            if (NF > 3) { print $1"/"$2"/.../"$NF } else { print $0 }
          }' | sort -u)

          read -r -d '' DETAILS_NOTE <<EOM || true
          *Detalle de los archivos:*
          \`\`\`text
          $FILES_LIST
          \`\`\`
          EOM

          send_note() {
            jq -n --arg desc "$1" '{ comment: { raw: $desc } }' > payload.json
            curl -s -o /dev/null -X POST "$OP_URL/api/v3/work_packages/$TICKET_ID/activities" \
              -H "Content-Type: application/json" -u "apikey:$OP_API_KEY" -d @payload.json
          }

          send_note "$VERSION_NOTE"
          send_note "$DETAILS_NOTE"

          # --- ACTUALIZAR ESTADO ---
          LOCK_VERSION=$(echo "$WP_DATA" | jq .lockVersion)
          if [ "$LOCK_VERSION" != "null" ]; then
            jq -n --argjson lock "$LOCK_VERSION" --arg status_href "/api/v3/statuses/$OP_NEW_STATUS_ID" \
              '{ lockVersion: $lock, _links: { status: { href: $status_href } } }' > status_payload.json
            curl -s -o /dev/null -X PATCH "$OP_URL/api/v3/work_packages/$TICKET_ID" \
              -H "Content-Type: application/json" -u "apikey:$OP_API_KEY" -d @status_payload.json
          fi

      - name: Notificar Despliegue por Correo
        if: success() && github.event_name == 'push'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ðŸš€ ProducciÃ³n: Ticket #${{ env.TICKET_ID }} Actualizado"
          to: ${{ env.TARGET_EMAIL }}
          from: GitHub Actions <noreply@github.com>
          body: |
            Se ha completado el despliegue a producciÃ³n con Ã©xito.

            DETALLES:
            -----------------------------------------
            Repositorio: ${{ env.REPO_NAME }}
            Ticket: #${{ env.TICKET_ID }}
            Commit: ${{ env.COMMIT_MSG }}
            SHA Actual: ${{ env.SHA_CURRENT }}
            
            ESTADO:
            El ticket ha sido movido a 'Compilado ProducciÃ³n' en OpenProject.

            Detalles del ticket:
            ${{ secrets.OP_INSTANCE_URL }}/work_packages/${{ env.TICKET_ID }}
