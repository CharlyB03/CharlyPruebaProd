name: Flujo de ProducciÃ³n y OpenProject

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deploy-logic:
    runs-on: ubuntu-latest
    # CORREGIDO: Tu usuario y repositorio real
    if: github.repository == 'CharlyB03/CharlyPruebaProd'

    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- FASE 1: VALIDACIÃ“N (Solo en Pull Request) ---
      - name: Validar PreproducciÃ³n
        if: github.event_name == 'pull_request'
        run: echo "âœ… PreproducciÃ³n OK"

      # --- FASE 2: PRODUCCIÃ“N (Solo al hacer Merge a Main) ---
      - name: Procesar ProducciÃ³n y Actualizar OpenProject
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          OP_API_KEY: ${{ secrets.OP_API_KEY }}
          OP_URL: ${{ secrets.OP_INSTANCE_URL }}
          OP_NEW_STATUS_ID: ${{ secrets.OP_STATUS_ID }}
        run: |
          # 1. OBTENER DATOS DE GIThubbb
          COMMIT_MSG=$(git log -1 --pretty=%s)
          SHA_CURRENT=$(git rev-parse --short HEAD)
          SHA_PARENT=$(git rev-parse --short HEAD^ 2>/dev/null || echo "init")
          
          if [ "$SHA_PARENT" == "init" ]; then
             FILE_DIFF="Primer despliegue"
          else
             FILE_DIFF=$(git --no-pager diff --name-only $SHA_CURRENT $SHA_PARENT)
          fi

          echo "ðŸ“ Mensaje del Commit: $COMMIT_MSG"

          # 2. EXTRACCIÃ“N DEL ID DEL TICKET
          # Busca el nombre de la rama en el mensaje de merge (ej: "from .../RamaPrueba38")
          BRANCH_FULL=$(echo "$COMMIT_MSG" | grep -oE 'from .+' | awk '{print $NF}')
          
          # Si fue un push directo, usamos el mensaje entero
          if [ -z "$BRANCH_FULL" ]; then
             BRANCH_FULL="$COMMIT_MSG"
          fi

          # Extrae solo los nÃºmeros al FINAL del texto
          TICKET_ID=$(echo "$BRANCH_FULL" | grep -oE '[0-9]+$' | head -n 1)
          
          if [ -z "$TICKET_ID" ]; then
            echo "âš ï¸ No se detectÃ³ nÃºmero de ticket al final del nombre (ej: Rama38)."
            exit 0
          fi
          
          echo "ðŸ” ID Detectado: #$TICKET_ID"

          # ---------------------------------------------------------
          # 3. DIAGNÃ“STICO DE CONEXIÃ“N (MODO DEBUG)
          # ---------------------------------------------------------
          echo "ðŸ“¡ Conectando a: $OP_URL/api/v3/work_packages/$TICKET_ID"
          
          # Intentamos conectar capturando TODOS los detalles (-v) y errores
          # --connect-timeout 10: Si tarda mÃ¡s de 10s, es un firewall bloqueando
          curl -v --connect-timeout 10 -u "apikey:$OP_API_KEY" \
            "$OP_URL/api/v3/work_packages/$TICKET_ID" > response_body.txt 2> response_log.txt
          
          # Leemos el cÃ³digo HTTP del log
          HTTP_STATUS=$(cat response_log.txt | grep "< HTTP/" | tail -1 | awk '{print $3}')
          
          echo "---------------------------------------------------"
          echo "ðŸ“„ LOG DE CONEXIÃ“N (Para Debug):"
          cat response_log.txt
          echo "---------------------------------------------------"
          echo "ðŸ“„ CUERPO DE LA RESPUESTA:"
          cat response_body.txt
          echo "---------------------------------------------------"

          # Si no hay respuesta vÃ¡lida, detenemos aquÃ­ para ver el error
          if [ -z "$HTTP_STATUS" ] || [ "$HTTP_STATUS" != "200" ]; then
             echo "âŒ FALLO DE CONEXIÃ“N. CÃ³digo HTTP: $HTTP_STATUS"
             echo "REVISA EL LOG DE ARRIBA:"
             echo " - Si dice 'Connection timed out': Tu servidor bloquea a GitHub (Firewall)."
             echo " - Si dice '401 Unauthorized': El Token estÃ¡ mal."
             echo " - Si dice '404 Not Found': La URL estÃ¡ mal o el ticket no existe."
             exit 1
          fi

          # Si llegamos aquÃ­, la conexiÃ³n funcionÃ³. Extraemos lockVersion.
          LOCK_VERSION=$(cat response_body.txt | jq .lockVersion)
          echo "ðŸ”“ Lock Version: $LOCK_VERSION"

          # 4. PREPARAR NOTAS
          read -r -d '' NOTE_TEXT <<EOM
          *5. Datos de versionamiento en producciÃ³n*

          *Versionado en:* Comreivic (GitHub)
          *Commit:* $COMMIT_MSG
          *sha1:* $SHA_CURRENT
          *sha1 Parent:* $SHA_PARENT
          *Extraer Archivos:*
          $FILE_DIFF
          EOM

          # 5. ENVIAR CAMBIOS A OPENPROJECT
          jq -n \
            --argjson lock "$LOCK_VERSION" \
            --arg desc "$NOTE_TEXT" \
            --arg status_href "/api/v3/statuses/$OP_NEW_STATUS_ID" \
            '{
              lockVersion: $lock,
              _links: { status: { href: $status_href } },
              journal: { raw: $desc }
            ' > payload.json

          echo "ðŸš€ Enviando actualizaciÃ³n..."
          curl -s -X PATCH "$OP_URL/api/v3/work_packages/$TICKET_ID" \
            -H "Content-Type: application/json" \
            -u "apikey:$OP_API_KEY" \
            -d @payload.json

          echo "âœ… Â¡Ticket #$TICKET_ID actualizado correctamente!"
