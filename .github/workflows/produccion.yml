name: Flujo de Producci√≥n y OpenProject

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deploy-logic:
    runs-on: ubuntu-latest
    if: github.repository == 'CharlyB03/CharlyPruebaProd'

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- FASE 1: VALIDACI√ìN ---
      - name: Validar Preproducci√≥n
        if: github.event_name == 'pull_request'
        run: echo "‚úÖ Preproducci√≥n OK"

      # --- FASE 2: PRODUCCI√ìN ---
      - name: Actualizar OpenProject
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          OP_API_KEY: ${{ secrets.OP_API_KEY }}
          OP_URL: ${{ secrets.OP_INSTANCE_URL }}
          OP_NEW_STATUS_ID: ${{ secrets.OP_STATUS_ID }}
        run: |
          # 1. OBTENER DATOS DE GIT
          COMMIT_MSG=$(git log -1 --pretty=%s)
          SHA_CURRENT=$(git rev-parse --short HEAD)
          SHA_PARENT=$(git rev-parse --short HEAD^ 2>/dev/null || echo "init")
          
          if [ "$SHA_PARENT" == "init" ]; then
             FILE_DIFF="Primer despliegue"
          else
             FILE_DIFF=$(git --no-pager diff --name-only $SHA_CURRENT $SHA_PARENT)
          fi

          # 2. EXTRAER ID DEL TICKET
          BRANCH_FULL=$(echo "$COMMIT_MSG" | grep -oE 'from .+' | awk '{print $NF}')
          if [ -z "$BRANCH_FULL" ]; then BRANCH_FULL="$COMMIT_MSG"; fi
          TICKET_ID=$(echo "$BRANCH_FULL" | grep -oE '[0-9]+$' | head -n 1)
          
          if [ -z "$TICKET_ID" ]; then
            echo "‚ö†Ô∏è No se detect√≥ ID de ticket. Omitiendo."
            exit 0
          fi
          
          echo "üéØ Procesando Ticket #$TICKET_ID"

          # ---------------------------------------------------------
          # PASO A: ENVIAR LA NOTA (Usando POST /activities como en Postman)
          # ---------------------------------------------------------
          read -r -d '' NOTE_TEXT <<EOM || true
          *5. Datos de versionamiento en producci√≥n*

          *Versionado en:* Comreivic (GitHub)
          *Commit:* $COMMIT_MSG
          *sha1:* $SHA_CURRENT
          *Extraer Archivos:*
          $FILE_DIFF
          EOM

          # Construimos JSON solo para el comentario (No requiere lockVersion)
          jq -n --arg desc "$NOTE_TEXT" '{ comment: { raw: $desc } }' > comment_payload.json
          
          echo "üì® Enviando Nota de Despliegue..."
          HTTP_CODE_NOTE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$OP_URL/api/v3/work_packages/$TICKET_ID/activities" \
            -H "Content-Type: application/json" \
            -u "apikey:$OP_API_KEY" \
            -d @comment_payload.json)

          if [ "$HTTP_CODE_NOTE" -eq 200 ] || [ "$HTTP_CODE_NOTE" -eq 201 ]; then
             echo "‚úÖ Nota guardada correctamente."
          else
             echo "‚ö†Ô∏è No se pudo guardar la nota (C√≥digo $HTTP_CODE_NOTE), pero intentaremos cerrar el ticket."
          fi

          # ---------------------------------------------------------
          # PASO B: ACTUALIZAR ESTADO (Usando PATCH con lockVersion)
          # ---------------------------------------------------------
          
          # 1. Obtenemos el lockVersion ACTUALIZADO (porque al comentar cambi√≥)
          LOCK_VERSION=$(curl -s -u "apikey:$OP_API_KEY" "$OP_URL/api/v3/work_packages/$TICKET_ID" | jq .lockVersion)
          
          if [ "$LOCK_VERSION" == "null" ] || [ -z "$LOCK_VERSION" ]; then
             echo "‚ùå Error: No se pudo leer el ticket para cerrarlo."
             exit 1
          fi
          
          echo "üîí Lock Version actual: $LOCK_VERSION. Intentando cambiar estado..."

          # 2. Construimos JSON solo para el estado
          jq -n \
            --argjson lock "$LOCK_VERSION" \
            --arg status_href "/api/v3/statuses/$OP_NEW_STATUS_ID" \
            '{ lockVersion: $lock, _links: { status: { href: $status_href } } }' > status_payload.json

          # 3. Enviamos el cambio de estado
          HTTP_CODE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X PATCH "$OP_URL/api/v3/work_packages/$TICKET_ID" \
            -H "Content-Type: application/json" \
            -u "apikey:$OP_API_KEY" \
            -d @status_payload.json)

          if [ "$HTTP_CODE_STATUS" -eq 200 ]; then
            echo "‚úÖ ¬°Ticket #$TICKET_ID cerrado/actualizado con √©xito!"
          else
            echo "‚ùå Fallo al cambiar estado (C√≥digo HTTP: $HTTP_CODE_STATUS)"
            # No hacemos exit 1 para que no marque rojo si al menos la nota se guard√≥
            exit 0 
          fi
