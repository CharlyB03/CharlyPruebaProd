- name: Actualizar OpenProject
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor == github.repository_owner
        env:
          OP_API_KEY: ${{ secrets.OP_API_KEY }}
          OP_URL: ${{ secrets.OP_INSTANCE_URL }}
          OP_NEW_STATUS_ID: ${{ secrets.OP_STATUS_ID }}
        run: |
          # --- 1. OBTENER DATOS DE GIT ---
          COMMIT_MSG=$(git log -1 --pretty=%s)
          SHA_CURRENT=$(git rev-parse --short HEAD)
          
          # TRUCO: Obtener solo el √öLTIMO padre (La rama que entr√≥)
          # 'awk {print $NF}' toma la √∫ltima palabra de la l√≠nea
          SHA_PARENT_RAW=$(git log -1 --pretty=%p | awk '{print $NF}')
          SHA_PARENT=$(git rev-parse --short $SHA_PARENT_RAW)
          
          REPO_NAME=${GITHUB_REPOSITORY#*/}
          
          # Diff contra ese padre espec√≠fico
          FILE_DIFF=$(git --no-pager diff --name-only $SHA_PARENT_RAW HEAD)

          # --- 2. EXTRAER ID DEL TICKET ---
          BRANCH_FULL=$(echo "$COMMIT_MSG" | grep -oE 'from .+' | awk '{print $NF}')
          if [ -z "$BRANCH_FULL" ]; then BRANCH_FULL="$COMMIT_MSG"; fi
          TICKET_ID=$(echo "$BRANCH_FULL" | grep -oE '[0-9]+$' | head -n 1)
          
          if [ -z "$TICKET_ID" ]; then
            echo "‚ö†Ô∏è No se detect√≥ ID. Fin."
            exit 0
          fi
          
          echo "üéØ Ticket #$TICKET_ID | Parent (Rama entrante): $SHA_PARENT"

          # --- 3. ENVIAR NOTA (POST) ---
          read -r -d '' NOTE_TEXT <<EOM || true
          *5. Datos de versionamiento en producci√≥n*

          *Repositorio:* $REPO_NAME
          *Commit:* $COMMIT_MSG
          *sha1 Actual:* $SHA_CURRENT
          *sha1 Parent:* $SHA_PARENT
          *Archivos Modificados:*
          $FILE_DIFF
          EOM

          jq -n --arg desc "$NOTE_TEXT" '{ comment: { raw: $desc } }' > comment_payload.json
          
          curl -s -o /dev/null -X POST "$OP_URL/api/v3/work_packages/$TICKET_ID/activities" \
            -H "Content-Type: application/json" \
            -u "apikey:$OP_API_KEY" \
            -d @comment_payload.json
          
          echo "‚úÖ Nota enviada."

          # --- 4. ACTUALIZAR ESTADO (PATCH) ---
          LOCK_VERSION=$(curl -s -u "apikey:$OP_API_KEY" "$OP_URL/api/v3/work_packages/$TICKET_ID" | jq .lockVersion)
          
          jq -n \
            --argjson lock "$LOCK_VERSION" \
            --arg status_href "/api/v3/statuses/$OP_NEW_STATUS_ID" \
            '{ lockVersion: $lock, _links: { status: { href: $status_href } } }' > status_payload.json

          curl -s -o /dev/null -X PATCH "$OP_URL/api/v3/work_packages/$TICKET_ID" \
            -H "Content-Type: application/json" \
            -u "apikey:$OP_API_KEY" \
            -d @status_payload.json
            
          echo "‚úÖ Estado actualizado."
