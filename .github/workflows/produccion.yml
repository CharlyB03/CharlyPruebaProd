name: Flujo de Producci√≥n y OpenProject

on:
  push:
    branches: [ "main" ]     # Se ejecuta al fusionar a Producci√≥n
  pull_request:
    branches: [ "main" ]     # Se ejecuta al validar (Preproducci√≥n)

jobs:
  deploy-logic:
    runs-on: ubuntu-latest
    # IMPORTANTE: Cambia 'CharlyPruebaProd/CharlyPruebaProd' por tu usuario/repo real si es diferente
    if: github.repository == 'CharlyPruebaProd/CharlyPruebaProd'

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesario para comparar commits y generar el historial

      # --- FASE 1: PREPRODUCCI√ìN (Solo corre en Pull Request) ---
      - name: Validar Preproducci√≥n
        if: github.event_name == 'pull_request'
        run: |
          echo "üõ†Ô∏è INICIO DE VALIDACI√ìN (PREPRODUCCI√ìN)..."
          echo "Aqu√≠ se ejecutar√≠an tus pruebas unitarias o linters."
          echo "‚úÖ Preproducci√≥n finalizada correctamente."

      # --- FASE 2: PRODUCCI√ìN (Solo corre al hacer Merge a main) ---
      - name: Procesar Producci√≥n y Actualizar OpenProject
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          # El script leer√° los valores que guardaste en GitHub Secrets
          OP_API_KEY: ${{ secrets.OP_API_KEY }}
          OP_URL: ${{ secrets.OP_INSTANCE_URL }}
          OP_NEW_STATUS_ID: ${{ secrets.OP_STATUS_ID }}
        run: |
          # --- 1. OBTENER DATOS DEL COMMIT Y GIT ---
          COMMIT_MSG=$(git log -1 --pretty=%s)
          SHA_CURRENT=$(git rev-parse --short HEAD)
          # Intentamos obtener el padre. Si es el primer commit, usamos un valor por defecto.
          SHA_PARENT=$(git rev-parse --short HEAD^ 2>/dev/null || echo "init")
          
          if [ "$SHA_PARENT" == "init" ]; then
             FILE_DIFF="Primer despliegue (todos los archivos)"
          else
             FILE_DIFF=$(git --no-pager diff --name-only $SHA_CURRENT $SHA_PARENT)
          fi

          echo "üìù Procesando Commit: $COMMIT_MSG"

          # --- 2. EXTRAER EL ID DEL TICKET (Busca formato OP#...) ---
          # Ejemplo: "Fix login OP#37" -> Extrae "37"
          TICKET_ID=$(echo "$COMMIT_MSG" | grep -oE 'OP#[0-9]+' | sed 's/OP#//')
          
          if [ -z "$TICKET_ID" ]; then
            echo "‚ö†Ô∏è AVISO: No se encontr√≥ un ID de ticket (formato OP#n√∫mero) en el mensaje del commit."
            echo "El despliegue contin√∫a, pero no se actualizar√° OpenProject."
            exit 0
          fi
          
          echo "üîç Ticket detectado: #$TICKET_ID"

          # --- 3. OBTENER VERSION DE BLOQUEO (LOCK VERSION) ---
          # Consultamos a OpenProject para poder editar el ticket de forma segura
          RESPONSE=$(curl -s -u "apikey:$OP_API_KEY" "$OP_URL/api/v3/work_packages/$TICKET_ID")
          
          # Extraemos el lockVersion con jq
          LOCK_VERSION=$(echo $RESPONSE | jq .lockVersion)
          
          # Validaci√≥n de seguridad: Si lockVersion es null, el ticket no existe o el token est√° mal
          if [ "$LOCK_VERSION" == "null" ] || [ "$LOCK_VERSION" == "" ]; then
             echo "‚ùå ERROR CR√çTICO: No se pudo acceder al ticket #$TICKET_ID."
             echo "Verifica: 1. Que el ticket exista. 2. Que el Token tenga permisos. 3. Que la URL sea correcta."
             echo "Respuesta del servidor: $RESPONSE"
             exit 1
          fi

          echo "üîì Versi√≥n de bloqueo obtenida: $LOCK_VERSION"

          # --- 4. PREPARAR LAS NOTAS DE VERSI√ìN ---
          # Usamos sintaxis heredoc para mantener el formato limpio
          read -r -d '' NOTE_TEXT <<EOM
          *5. Datos de versionamiento en producci√≥n*

          *Versionado en:* Comreivic (GitHub)
          *Commit:* $COMMIT_MSG
          *sha1:* $SHA_CURRENT
          *sha1 Parent:* $SHA_PARENT
          *Extraer Archivos:*
          $FILE_DIFF
          EOM

          # --- 5. ENVIAR ACTUALIZACI√ìN A OPENPROJECT ---
          # Construimos el JSON para cambiar estado y agregar comentario (journal)
          jq -n \
            --argjson lock "$LOCK_VERSION" \
            --arg desc "$NOTE_TEXT" \
            --arg status_href "/api/v3/statuses/$OP_NEW_STATUS_ID" \
            '{
              lockVersion: $lock,
              _links: {
                status: { href: $status_href }
              },
              journal: $desc 
            ' > payload.json

          echo "üöÄ Enviando datos a OpenProject ($OP_URL)..."
          
          # Usamos -w para ver el c√≥digo HTTP de respuesta
          HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" -X PATCH "$OP_URL/api/v3/work_packages/$TICKET_ID" \
            -H "Content-Type: application/json" \
            -u "apikey:$OP_API_KEY" \
            -d @payload.json)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ ¬°√âXITO! Ticket #$TICKET_ID actualizado correctamente."
          else
            echo "‚ùå ERROR al actualizar. C√≥digo HTTP: $HTTP_CODE"
            cat response.json
            exit 1
          fi