name: Flujo de Producción y OpenProject

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  deploy-logic:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validar Preproducción
        if: github.event_name == 'pull_request'
        run: echo "✅ Preproducción OK"

      - name: Actualizar OpenProject
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.repository == 'CharlyB03/CharlyPruebaProd'
        env:
          OP_API_KEY: ${{ secrets.OP_API_KEY }}
          OP_URL: ${{ secrets.OP_INSTANCE_URL }}
          OP_NEW_STATUS_ID: ${{ secrets.OP_STATUS_ID }}
        run: |
          # --- OBTENER DATOS ---
          COMMIT_MSG=$(git log -1 --pretty=%s)
          SHA_CURRENT=$(git rev-parse --short HEAD)
          
          # Cambiado a $1 para obtener el SHA del Merge anterior en la rama main
          SHA_PARENT_RAW=$(git log -1 --pretty=%p | awk '{print $1}')
          SHA_PARENT=$(git rev-parse --short $SHA_PARENT_RAW)
          REPO_NAME=${GITHUB_REPOSITORY#*/}

          # --- EXTRAER ID TICKET ---
          BRANCH_FULL=$(echo "$COMMIT_MSG" | grep -oE 'from .+' | awk '{print $NF}')
          if [ -z "$BRANCH_FULL" ]; then BRANCH_FULL="$COMMIT_MSG"; fi
          TICKET_ID=$(echo "$BRANCH_FULL" | grep -oE '[0-9]+$' | head -n 1)
          
          if [ -z "$TICKET_ID" ]; then
            echo "⚠️ No se detectó ID. Fin."
            exit 0
          fi

          # --- NOTA 1: DATOS DE VERSIONAMIENTO ---
          read -r -d '' VERSION_NOTE <<EOM || true
          *Datos de versionamiento en producción*
          *Versionado en:* $REPO_NAME (GitHub)
          *Commit:* $COMMIT_MSG
          *sha1:* $SHA_CURRENT
          *sha1 Parent:* $SHA_PARENT
          *Extraer Archivos*
          git --no-pager diff --name-only $SHA_PARENT $SHA_CURRENT
          EOM

          # --- NOTA 2: DETALLE DE ARCHIVOS ---
          # Transforma "modules/ventas/sub/clase.java" en "modules/ventas/.../clase.java"
          FILES_LIST=$(git diff --name-only $SHA_PARENT $SHA_CURRENT | awk -F/ '{
            if (NF > 3) {
              print $1"/"$2"/.../"$NF
            } else {
              print $0
            }
          }' | sort -u)

          read -r -d '' DETAILS_NOTE <<EOM || true
          *Detalle de los archivos:*
          \`\`\`text
          $FILES_LIST
          \`\`\`
          EOM

          # --- FUNCIÓN PARA ENVIAR NOTAS ---
          send_note() {
            jq -n --arg desc "$1" '{ comment: { raw: $desc } }' > payload.json
            curl -s -o /dev/null -X POST "$OP_URL/api/v3/work_packages/$TICKET_ID/activities" \
              -H "Content-Type: application/json" \
              -u "apikey:$OP_API_KEY" \
              -d @payload.json
          }

          # Enviar ambas notas por separado
          send_note "$VERSION_NOTE"
          send_note "$DETAILS_NOTE"
          echo "✅ Notas técnicas enviadas."

          # --- ACTUALIZAR ESTADO ---
          LOCK_VERSION=$(curl -s -u "apikey:$OP_API_KEY" "$OP_URL/api/v3/work_packages/$TICKET_ID" | jq .lockVersion)
          
          if [ "$LOCK_VERSION" != "null" ] && [ ! -z "$LOCK_VERSION" ]; then
            jq -n \
              --argjson lock "$LOCK_VERSION" \
              --arg status_href "/api/v3/statuses/$OP_NEW_STATUS_ID" \
              '{ lockVersion: $lock, _links: { status: { href: $status_href } } }' > status_payload.json

            curl -s -o /dev/null -X PATCH "$OP_URL/api/v3/work_packages/$TICKET_ID" \
              -H "Content-Type: application/json" \
              -u "apikey:$OP_API_KEY" \
              -d @status_payload.json
            echo "✅ Estado actualizado a Compilado Producción."
          else
            echo "❌ No se pudo actualizar el estado."
          fi
